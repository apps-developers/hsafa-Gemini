version: "1.0"

agent:
  name: multi-mcp-rag
  description: Support + docs agent using multiple MCP servers and a local reranker.
  system: |
    You are a technical support + documentation agent.
    Use MCP tools to fetch relevant sources.
    When you answer, cite which sources you used.

model:
  provider: openai
  name: gpt-4o-mini
  temperature: 0.2
  maxOutputTokens: 1400

loop:
  maxSteps: 16
  toolChoice: auto

mcp:
  servers:
    - name: github
      url: ${env.GITHUB_MCP_URL}
      transport: http
      headers:
        Authorization: Bearer ${env.GITHUB_TOKEN}
      allowedTools:
        - search_issues
        - get_issue
        - search_pull_requests
        - get_pull_request

    - name: docs
      url: ${env.DOCS_MCP_URL}
      transport: http
      headers:
        Authorization: Bearer ${env.DOCS_MCP_TOKEN}
      allowedTools:
        - search_docs
        - get_doc

tools:
  - id: rerank
    type: inline_js
    description: Rerank candidate passages by simple heuristic scoring.
    inputSchema:
      type: object
      properties:
        query:
          type: string
        passages:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              text:
                type: string
            required: [id, text]
      required: [query, passages]
    runtime:
      sandbox: true
      timeoutMs: 1500
    execute: |
      export default async function execute({ query, passages }) {
        const q = String(query).toLowerCase();
        const scored = (passages ?? []).map(p => {
          const text = String(p.text ?? '').toLowerCase();
          const score = q
            .split(/\s+/)
            .filter(Boolean)
            .reduce((acc, tok) => acc + (text.includes(tok) ? 1 : 0), 0);
          return { ...p, score };
        });

        scored.sort((a, b) => (b.score ?? 0) - (a.score ?? 0));
        return { passages: scored.slice(0, 5) };
      }

runtime:
  response:
    type: ui-message-stream
